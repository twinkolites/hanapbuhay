<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Verification - Hanapbuhay</title>

    <!-- Security Headers (Meta Tag Implementation) -->
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta
      http-equiv="Referrer-Policy"
      content="strict-origin-when-cross-origin"
    />
    <meta
      http-equiv="Permissions-Policy"
      content="geolocation=(), microphone=(), camera=()"
    />

    <!-- Content Security Policy - Strict for email verification page -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
      default-src 'self';
      script-src 'self' https://unpkg.com https://cdn.jsdelivr.net 'unsafe-inline';
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      font-src 'self' https://fonts.gstatic.com;
      img-src 'self' data:;
      connect-src 'self' https://jhpjpenbtazudqfrkogf.supabase.co wss://jhpjpenbtazudqfrkogf.supabase.co;
      frame-ancestors 'none';
      base-uri 'self';
      form-action 'none';
      upgrade-insecure-requests;
    "
    />

    <!-- Additional Security Meta Tags -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet" />

    <!-- Supabase SDK -->
    <script
      src="https://unpkg.com/@supabase/supabase-js@2"
      integrity="sha384-xxx"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #eaf9e7 0%, #c0e6ba 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        max-width: 500px;
        margin: 20px;
        background-color: #ffffff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 16px;
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #4ca771 0%, #66bb6a 100%);
        padding: 30px 20px;
        text-align: center;
        color: white;
      }
      .header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
      }
      .content {
        padding: 30px 20px;
      }
      .loading {
        text-align: center;
        padding: 40px 20px;
      }
      .loading .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4ca771;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .success-icon {
        text-align: center;
        margin-bottom: 20px;
      }
      .success-icon .icon {
        font-size: 64px;
        color: #4ca771;
      }
      .error-icon {
        text-align: center;
        margin-bottom: 20px;
      }
      .error-icon .icon {
        font-size: 64px;
        color: #f44336;
      }
      .message {
        text-align: center;
        margin-bottom: 30px;
      }
      .message h2 {
        color: #013237;
        font-size: 20px;
        margin-bottom: 10px;
      }
      .message p {
        color: #666;
        font-size: 16px;
        margin-bottom: 20px;
      }
      .instructions {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
      }
      .instructions.show {
        display: block;
      }
      .instructions h3 {
        color: #013237;
        font-size: 18px;
        margin-bottom: 15px;
      }
      .instruction-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
      }
      .instruction-number {
        background-color: #4ca771;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
      }
      .app-link {
        display: inline-block;
        background-color: #4ca771;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 10px;
        transition: background-color 0.3s;
      }
      .app-link:hover {
        background-color: #3d8f5e;
      }
      .footer {
        background-color: #013237;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 14px;
      }
      .footer p {
        margin: 5px 0;
        opacity: 0.9;
      }
      .troubleshooting {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
      }
      .troubleshooting h4 {
        color: #856404;
        margin-bottom: 10px;
      }
      .troubleshooting p {
        color: #856404;
        font-size: 14px;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1 id="pageTitle">Verifying Email...</h1>
      </div>

      <!-- Main Content -->
      <div class="content">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
          <div class="spinner"></div>
          <p>Verifying your email address...</p>
        </div>

        <!-- Success State -->
        <div id="successState" style="display: none">
          <div class="success-icon">
            <div class="icon">✅</div>
          </div>
          <div class="message">
            <h2>Your email has been successfully verified!</h2>
            <p>
              Welcome to Hanapbuhay! Your account is now active and ready to
              use.
            </p>
          </div>
          <div class="instructions show">
            <h3>To continue using the app:</h3>
            <div class="instruction-item">
              <div class="instruction-number">1</div>
              <div class="instruction-text">
                Open the Hanapbuhay app on your phone
              </div>
            </div>
            <div class="instruction-item">
              <div class="instruction-number">2</div>
              <div class="instruction-text">
                Sign in with your email and password
              </div>
            </div>
            <div class="instruction-item">
              <div class="instruction-number">3</div>
              <div class="instruction-text">
                Start exploring job opportunities!
              </div>
            </div>
          </div>
          <div style="text-align: center">
            <a href="#" id="appLink" class="app-link">Open Hanapbuhay App</a>
            <p style="font-size: 12px; color: #666; margin-top: 10px">
              If the app doesn't open, please open it manually on your phone.
            </p>
          </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none">
          <div class="error-icon">
            <div class="icon">❌</div>
          </div>
          <div class="message">
            <h2>Verification Failed</h2>
            <p id="errorMessage">
              There was an error verifying your email. Please try again.
            </p>
          </div>
          <div style="text-align: center">
            <a href="#" onclick="window.close()" class="app-link">Close</a>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p><strong>Hanapbuhay</strong></p>
        <p>Connecting Filipino job seekers with employers nationwide</p>
        <p style="font-size: 12px; opacity: 0.7; margin-top: 10px">
          This is an automated verification page.
        </p>
      </div>
    </div>

    <script>
      // Security: Input sanitization and validation functions
      function sanitizeString(input) {
        if (typeof input !== "string") return "";
        // Remove potentially dangerous characters and limit length
        return input.replace(/[<>'"&]/g, "").substring(0, 1000);
      }

      function validateToken(token) {
        if (!token || typeof token !== "string") return false;
        // Basic JWT-like validation (should be 3 parts separated by dots)
        const parts = token.split(".");
        return parts.length === 3 && parts.every((part) => part.length > 0);
      }

      // Security: Rate limiting for function calls
      const callTracker = new Map();
      function rateLimit(funcName, maxCalls = 5, timeWindow = 60000) {
        const now = Date.now();
        const calls = callTracker.get(funcName) || [];

        // Remove old calls outside the time window
        const recentCalls = calls.filter((call) => now - call < timeWindow);

        if (recentCalls.length >= maxCalls) {
          console.warn(`Rate limit exceeded for ${funcName}`);
          return false;
        }

        recentCalls.push(now);
        callTracker.set(funcName, recentCalls);
        return true;
      }

      // Security: Secure error logging (no sensitive data)
      function secureLog(level, message, data = {}) {
        const sanitizedData = Object.keys(data).reduce((acc, key) => {
          acc[key] = typeof data[key] === "string" ? "[REDACTED]" : data[key];
          return acc;
        }, {});

        console[level](`[SECURE] ${message}`, sanitizedData);
      }

      // Initialize Supabase with security checks
      const supabaseUrl = "https://jhpjpenbtazudqfrkogf.supabase.co";
      const supabaseAnonKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpocGpwZW5idGF6dWRxZnJrb2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MjI4MzAsImV4cCI6MjA3MDI5ODgzMH0.pa_xmaWBACJ_8g-wML6z2DEEPa6tHJbXH6S5NndQt2E";

      // Security validation
      if (
        !supabaseUrl.startsWith("https://") ||
        !supabaseAnonKey.startsWith("eyJ")
      ) {
        showError("Security configuration error. Please contact support.");
        return;
      }

      let supabase;
      try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
      } catch (e) {
        secureLog("error", "Failed to initialize Supabase client", {
          error: e.message,
        });
        showError("Failed to initialize verification service.");
        return;
      }

      // Security: Validate and sanitize URL parameters
      let urlParams, accessToken, refreshToken, type, error;

      try {
        urlParams = new URLSearchParams(window.location.search);

        // Sanitize and validate all URL parameters
        accessToken = sanitizeString(urlParams.get("access_token") || "");
        refreshToken = sanitizeString(urlParams.get("refresh_token") || "");
        type = sanitizeString(urlParams.get("type") || "");
        error = sanitizeString(urlParams.get("error") || "");

        // Validate tokens if present
        if (accessToken && !validateToken(accessToken)) {
          throw new Error("Invalid access token format");
        }
        if (refreshToken && !validateToken(refreshToken)) {
          throw new Error("Invalid refresh token format");
        }
      } catch (e) {
        secureLog("error", "URL parameter validation failed", {
          error: e.message,
        });
        showError("Invalid verification link parameters.");
        return;
      }

      // Log sanitized verification parameters (no sensitive data)
      secureLog("info", "Verification attempt", {
        hasAccessToken: !!accessToken,
        hasRefreshToken: !!refreshToken,
        type: type,
        hasError: !!error,
      });

      async function handleVerification() {
        // Security: Rate limit verification attempts
        if (!rateLimit("handleVerification", 3, 300000)) {
          // 3 attempts per 5 minutes
          showError(
            "Too many verification attempts. Please wait before trying again."
          );
          return;
        }

        try {
          // Security: Additional validation before processing
          if (error && error.length > 100) {
            secureLog("warn", "Suspicious error parameter length");
            showError("Invalid verification link.");
            return;
          }

          // Check for errors first
          if (error) {
            secureLog("info", "Verification failed with error", {
              errorType: "url_error",
            });
            showError(`Verification failed: ${sanitizeString(error)}`);
            return;
          }

          // If we have tokens, set the session with additional security checks
          if (accessToken && refreshToken) {
            secureLog("info", "Processing token-based verification");

            // Additional security: Validate token expiration (rough check)
            try {
              const tokenPayload = JSON.parse(atob(accessToken.split(".")[1]));
              const now = Math.floor(Date.now() / 1000);

              if (tokenPayload.exp && tokenPayload.exp < now) {
                secureLog("warn", "Token expired before verification");
                showError(
                  "Verification link has expired. Please request a new one."
                );
                return;
              }
            } catch (e) {
              secureLog("warn", "Could not validate token expiration");
              // Continue anyway, let Supabase handle it
            }

            const { data, error: sessionError } =
              await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken,
              });

            if (sessionError) {
              secureLog("error", "Session setup failed", {
                errorCode: sessionError.message,
              });
              showError("Failed to verify your account. Please try again.");
              return;
            }

            secureLog("info", "Session established successfully");
            showSuccess();

            // Note: Don't auto-open app after verification
            // User can manually click "Open Hanapbuhay App" button
            // This prevents conflicts with the hybrid verification flow
          } else if (type === "signup") {
            // Email confirmed but no tokens in URL (normal flow)
            secureLog("info", "Processing signup confirmation");
            showSuccess();
            // Note: Don't auto-open app - let user manually open via button
          } else {
            secureLog("warn", "Invalid verification parameters", {
              type,
              hasTokens: !!(accessToken && refreshToken),
            });
            showError(
              "Invalid verification link. Please request a new verification email."
            );
          }
        } catch (err) {
          secureLog("error", "Unexpected verification error", {
            errorType: err.name,
          });
          showError("An unexpected error occurred during verification.");
        }
      }

      function tryOpenApp() {
        // Security: Rate limit app opening attempts
        if (!rateLimit("tryOpenApp", 2, 10000)) {
          // 2 attempts per 10 seconds
          secureLog("info", "App opening rate limited");
          return;
        }

        const appUrl = "io.supabase.hanapbuhay://";

        // Security: Validate app URL format
        if (!appUrl.startsWith("io.supabase.hanapbuhay://")) {
          secureLog("error", "Invalid app URL format");
          return;
        }

        secureLog("info", "Attempting to open mobile app");

        // Clear any existing timers to prevent multiple redirects
        if (window.appOpenTimer) {
          clearTimeout(window.appOpenTimer);
        }

        // Try multiple methods to open the app with security checks
        try {
          // Method 1: Direct location change (most reliable for mobile)
          window.location.href = appUrl;
        } catch (e) {
          secureLog("warn", "Direct location change failed", {
            error: e.message,
          });
        }

        // Method 2: Hidden iframe approach (works on some mobile browsers)
        setTimeout(() => {
          try {
            const iframe = document.createElement("iframe");
            iframe.style.display = "none";
            iframe.src = appUrl;
            document.body.appendChild(iframe);

            // Clean up after a delay
            setTimeout(() => {
              if (iframe.parentNode) {
                iframe.parentNode.removeChild(iframe);
              }
            }, 2000);
          } catch (e) {
            secureLog("warn", "Iframe method failed", { error: e.message });
          }
        }, 500);

        // Method 3: New tab/window as last resort (desktop browsers)
        window.appOpenTimer = setTimeout(() => {
          try {
            const newTab = window.open(appUrl, "_blank", "noopener,noreferrer");
            if (newTab) {
              newTab.focus();
              // Close the tab after a delay if it didn't redirect to the app
              setTimeout(() => {
                try {
                  newTab.close();
                } catch (e) {
                  // Tab may have already navigated or been closed
                }
              }, 3000);
            }
          } catch (e) {
            secureLog("warn", "New tab method failed", { error: e.message });
          }
        }, 1000);
      }

      function showSuccess() {
        // Security: Clear sensitive data from memory
        accessToken = null;
        refreshToken = null;

        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "block";
        document.getElementById("errorState").style.display = "none";
        document.getElementById("pageTitle").textContent = "✅ Email Verified!";

        // Update app link with security validation
        const appLink = document.getElementById("appLink");
        if (appLink) {
          appLink.href = "io.supabase.hanapbuhay://";
          // Security: Add click tracking for analytics (without sensitive data)
          appLink.addEventListener("click", () => {
            secureLog("info", "User clicked app link manually");
          });
        }

        secureLog("info", "Verification success displayed to user");
      }

      function showError(message) {
        // Security: Sanitize error message before display
        const sanitizedMessage = sanitizeString(message).substring(0, 200);

        // Security: Clear sensitive data on error
        accessToken = null;
        refreshToken = null;

        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("pageTitle").textContent =
          "❌ Verification Failed";

        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.textContent = sanitizedMessage;
        }

        secureLog("warn", "Verification error displayed to user", {
          errorLength: sanitizedMessage.length,
        });
      }

      // Security: Cleanup sensitive data on page unload
      window.addEventListener("beforeunload", () => {
        accessToken = null;
        refreshToken = null;
        if (window.appOpenTimer) {
          clearTimeout(window.appOpenTimer);
        }
      });

      // Security: Prevent context menu and right-click (optional, for additional security)
      document.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        return false;
      });

      // Security: Prevent drag operations
      document.addEventListener("dragstart", (e) => {
        e.preventDefault();
        return false;
      });

      // Start verification process
      handleVerification();
    </script>
  </body>
</html>
