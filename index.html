<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Verification - Hanapbuhay</title>

    <!-- Security Headers (Meta Tag Implementation) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta
      http-equiv="Referrer-Policy"
      content="strict-origin-when-cross-origin"
    />

    <!-- Basic Content Security Policy -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://unpkg.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data:;
      font-src 'self';
      connect-src 'self' https://jhpjpenbtazudqfrkogf.supabase.co wss://jhpjpenbtazudqfrkogf.supabase.co;
      frame-src 'none';
      base-uri 'self';
      form-action 'none';
    "
    />

    <!-- Additional Security Meta Tags -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet" />

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #eaf9e7 0%, #c0e6ba 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        max-width: 500px;
        margin: 20px;
        background-color: #ffffff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 16px;
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #4ca771 0%, #66bb6a 100%);
        padding: 30px 20px;
        text-align: center;
        color: white;
      }
      .header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
      }
      .content {
        padding: 30px 20px;
      }
      .loading {
        text-align: center;
        padding: 40px 20px;
      }
      .loading .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4ca771;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .success-icon {
        text-align: center;
        margin-bottom: 20px;
      }
      .success-icon .icon {
        font-size: 64px;
        color: #4ca771;
      }
      .error-icon {
        text-align: center;
        margin-bottom: 20px;
      }
      .error-icon .icon {
        font-size: 64px;
        color: #f44336;
      }
      .message {
        text-align: center;
        margin-bottom: 30px;
      }
      .message h2 {
        color: #013237;
        font-size: 20px;
        margin-bottom: 10px;
      }
      .message p {
        color: #666;
        font-size: 16px;
        margin-bottom: 20px;
      }
      .instructions {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
      }
      .instructions.show {
        display: block;
      }
      .instructions h3 {
        color: #013237;
        font-size: 18px;
        margin-bottom: 15px;
      }
      .instruction-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
      }
      .instruction-number {
        background-color: #4ca771;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
      }
      .app-link {
        display: inline-block;
        background-color: #4ca771;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 10px;
        transition: background-color 0.3s;
      }
      .app-link:hover {
        background-color: #3d8f5e;
      }
      .footer {
        background-color: #013237;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 14px;
      }
      .footer p {
        margin: 5px 0;
        opacity: 0.9;
      }
      .troubleshooting {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
      }
      .troubleshooting h4 {
        color: #856404;
        margin-bottom: 10px;
      }
      .troubleshooting p {
        color: #856404;
        font-size: 14px;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1 id="pageTitle">Verifying Email...</h1>
      </div>

      <!-- Main Content -->
      <div class="content">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
          <div class="spinner"></div>
          <p>Verifying your email address...</p>
        </div>

        <!-- Success State -->
        <div id="successState" style="display: none">
          <div class="success-icon">
            <div class="icon">✅</div>
          </div>
          <div class="message">
            <h2>Your email has been successfully verified!</h2>
            <p>
              Welcome to Hanapbuhay! Your account is now active and ready to
              use.
            </p>
          </div>
          <div class="instructions show">
            <h3>To continue using the app:</h3>
            <div class="instruction-item">
              <div class="instruction-number">1</div>
              <div class="instruction-text">
                Open the Hanapbuhay app on your phone
              </div>
            </div>
            <div class="instruction-item">
              <div class="instruction-number">2</div>
              <div class="instruction-text">
                Sign in with your email and password
              </div>
            </div>
            <div class="instruction-item">
              <div class="instruction-number">3</div>
              <div class="instruction-text">
                Start exploring job opportunities!
              </div>
            </div>
          </div>
          <div style="text-align: center">
            <a href="#" id="appLink" class="app-link">Open Hanapbuhay App</a>
            <p style="font-size: 12px; color: #666; margin-top: 10px">
              If the app doesn't open, please open it manually on your phone.
            </p>
          </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none">
          <div class="error-icon">
            <div class="icon">❌</div>
          </div>
          <div class="message">
            <h2>Verification Failed</h2>
            <p id="errorMessage">
              There was an error verifying your email. Please try again.
            </p>
          </div>
          <div style="text-align: center">
            <a href="#" onclick="window.close()" class="app-link">Close</a>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p><strong>Hanapbuhay</strong></p>
        <p>Connecting Filipino job seekers with employers nationwide</p>
        <p style="font-size: 12px; opacity: 0.7; margin-top: 10px">
          This is an automated verification page.
        </p>
      </div>
    </div>

    <script>
      // Security: Input sanitization and validation functions
      function sanitizeString(input) {
        if (typeof input !== "string") return "";
        // Remove potentially dangerous characters and limit length
        return input.replace(/[<>'"&]/g, "").substring(0, 1000);
      }

      function validateToken(token) {
        if (!token || typeof token !== "string") return false;
        // Basic JWT-like validation (should be 3 parts separated by dots)
        const parts = token.split(".");
        return parts.length === 3 && parts.every((part) => part.length > 0);
      }

      // Security: Rate limiting for function calls
      const callTracker = new Map();
      function rateLimit(funcName, maxCalls = 5, timeWindow = 60000) {
        const now = Date.now();
        const calls = callTracker.get(funcName) || [];

        // Remove old calls outside the time window
        const recentCalls = calls.filter((call) => now - call < timeWindow);

        if (recentCalls.length >= maxCalls) {
          console.warn(`Rate limit exceeded for ${funcName}`);
          return false;
        }

        recentCalls.push(now);
        callTracker.set(funcName, recentCalls);
        return true;
      }

      // Enterprise Security: Advanced logging and monitoring
      function secureLog(level, message, data = {}) {
        const sanitizedData = Object.keys(data).reduce((acc, key) => {
          acc[key] = typeof data[key] === "string" ? "[REDACTED]" : data[key];
          return acc;
        }, {});

        // Add security context to all logs
        const securityContext = {
          timestamp: new Date().toISOString(),
          sessionId: generateSecureId(),
          userAgent: navigator.userAgent.substring(0, 100),
          url: window.location.href,
          referrer: document.referrer || "none",
          ...sanitizedData,
        };

        console[level](`[ENTERPRISE_SECURITY] ${message}`, securityContext);

        // Store security events for monitoring (in production, this would be sent to a security service)
        storeSecurityEvent(level, message, securityContext);
      }

      // Security: Generate secure session IDs
      function generateSecureId() {
        return (
          "sec_" +
          Date.now().toString(36) +
          "_" +
          Math.random().toString(36).substr(2, 9)
        );
      }

      // Security: Store security events (in production, send to security monitoring service)
      const securityEvents = [];
      function storeSecurityEvent(level, message, context) {
        securityEvents.push({
          level,
          message,
          context,
          timestamp: new Date().toISOString(),
        });

        // Limit stored events to prevent memory issues
        if (securityEvents.length > 50) {
          securityEvents.shift();
        }

        // In production, you would send this to a security monitoring service
        // console.log('Security Event Stored:', securityEvents.length, 'events');
      }

      // Initialize Supabase with security checks
      (function() {
        const supabaseUrl = "https://jhpjpenbtazudqfrkogf.supabase.co";
        const supabaseAnonKey =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpocGpwZW5idGF6dWRxZnJrb2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MjI4MzAsImV4cCI6MjA3MDI5ODgzMH0.pa_xmaWBACJ_8g-wML6z2DEEPa6tHJbXH6S5NndQt2E";

        // Security validation
        if (
          !supabaseUrl.startsWith("https://") ||
          !supabaseAnonKey.startsWith("eyJ")
        ) {
          showError("Security configuration error. Please contact support.");
          return;
        }

      let supabase;
      try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
      } catch (e) {
        secureLog("error", "Failed to initialize Supabase client", {
          error: e.message,
        });
        showError("Failed to initialize verification service.");
        return;
      }

      // Security: Validate and sanitize URL parameters
      let urlParams, accessToken, refreshToken, type, error, code;

      try {
        urlParams = new URLSearchParams(window.location.search);

        // Handle both Supabase parameter formats
        // Legacy format: access_token, refresh_token, type, error
        // New format: code (for email verification)
        code = sanitizeString(urlParams.get("code") || "");
        accessToken = sanitizeString(urlParams.get("access_token") || "");
        refreshToken = sanitizeString(urlParams.get("refresh_token") || "");
        type = sanitizeString(urlParams.get("type") || "");
        error = sanitizeString(urlParams.get("error") || "");

        // Validate parameters
        if (code && code.length < 10) {
          throw new Error("Invalid verification code format");
        }
        if (accessToken && !validateToken(accessToken)) {
          throw new Error("Invalid access token format");
        }
        if (refreshToken && !validateToken(refreshToken)) {
          throw new Error("Invalid refresh token format");
        }
      } catch (e) {
        secureLog("error", "URL parameter validation failed", {
          error: e.message,
        });
        showError("Invalid verification link parameters.");
        return;
      }

      // Log sanitized verification parameters (no sensitive data)
      secureLog("info", "Verification attempt", {
        hasCode: !!code,
        hasAccessToken: !!accessToken,
        hasRefreshToken: !!refreshToken,
        type: type,
        hasError: !!error,
      });

      async function handleVerification() {
        // Security: Rate limit verification attempts
        if (!rateLimit("handleVerification", 3, 300000)) {
          // 3 attempts per 5 minutes
          showError(
            "Too many verification attempts. Please wait before trying again."
          );
          return;
        }

        try {
          // Security: Additional validation before processing
          if (error && error.length > 100) {
            secureLog("warn", "Suspicious error parameter length");
            showError("Invalid verification link.");
            return;
          }

          // Check for errors first
          if (error) {
            secureLog("info", "Verification failed with error", {
              errorType: "url_error",
            });
            showError(`Verification failed: ${sanitizeString(error)}`);
            return;
          }

          // Handle different verification scenarios
          if (code) {
            // Supabase email verification using code
            secureLog("info", "Processing code-based email verification", {
              codeLength: code.length,
              codePrefix: code.substring(0, 8) + "...",
            });

            try {
              // Try verifyOtp first (for magic link/email verification)
              const { data, error: verifyError } =
                await supabase.auth.verifyOtp({
                  token: code,
                  type: "email",
                });

              if (verifyError) {
                secureLog(
                  "warn",
                  "verifyOtp failed, trying exchangeCodeForSession",
                  {
                    errorCode: verifyError.message,
                    errorName: verifyError.name,
                  }
                );

                // If verifyOtp fails, try exchangeCodeForSession (for PKCE flow)
                try {
                  const { data: sessionData, error: exchangeError } =
                    await supabase.auth.exchangeCodeForSession(code);

                  if (exchangeError) {
                    secureLog("error", "Both verification methods failed", {
                      verifyOtpError: verifyError.message,
                      exchangeError: exchangeError.message,
                    });
                    showError("Failed to verify your email. Please try again.");
                    return;
                  }

                  secureLog(
                    "info",
                    "Email verification successful via exchangeCodeForSession"
                  );
                  showSuccess();

                  // Try to open the app automatically after a short delay
                  setTimeout(() => {
                    tryOpenApp();
                  }, 2000);
                } catch (exchangeException) {
                  secureLog("error", "exchangeCodeForSession exception", {
                    error: exchangeException.message,
                  });
                  showError("Failed to verify your email. Please try again.");
                  return;
                }
              } else {
                // verifyOtp succeeded
                secureLog(
                  "info",
                  "Email verification successful via verifyOtp"
                );
                showSuccess();

                // Try to open the app automatically after a short delay
                setTimeout(() => {
                  tryOpenApp();
                }, 2000);
              }
            } catch (e) {
              secureLog("error", "Verification process error", {
                error: e.message,
                errorType: e.name,
                stack: e.stack ? e.stack.substring(0, 200) : "no stack",
              });
              showError("An error occurred during verification: " + e.message);
            }
          } else if (accessToken && refreshToken) {
            secureLog("info", "Processing token-based verification");

            // Additional security: Validate token expiration (rough check)
            try {
              const tokenPayload = JSON.parse(atob(accessToken.split(".")[1]));
              const now = Math.floor(Date.now() / 1000);

              if (tokenPayload.exp && tokenPayload.exp < now) {
                secureLog("warn", "Token expired before verification");
                showError(
                  "Verification link has expired. Please request a new one."
                );
                return;
              }
            } catch (e) {
              secureLog("warn", "Could not validate token expiration");
              // Continue anyway, let Supabase handle it
            }

            const { data, error: sessionError } =
              await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken,
              });

            if (sessionError) {
              secureLog("error", "Session setup failed", {
                errorCode: sessionError.message,
              });
              showError("Failed to verify your account. Please try again.");
              return;
            }

            secureLog("info", "Session established successfully");
            showSuccess();

            // Note: Don't auto-open app after verification
            // User can manually click "Open Hanapbuhay App" button
            // This prevents conflicts with the hybrid verification flow
          } else if (type === "signup") {
            // Email confirmed but no tokens in URL (normal flow)
            secureLog("info", "Processing signup confirmation");
            showSuccess();
            // Note: Don't auto-open app - let user manually open via button
          } else {
            // Handle direct access to the page (no URL parameters)
            const hasAnyParams = window.location.search.length > 1; // More than just '?'

            if (!hasAnyParams) {
              // User visited the page directly without parameters
              secureLog("info", "Direct page access without parameters");
              showDirectAccess();
            } else {
              // User has parameters but they're invalid
              secureLog("warn", "Invalid verification parameters", {
                type,
                hasTokens: !!(accessToken && refreshToken),
              });
              showError(
                "Invalid verification link. Please request a new verification email."
              );
            }
          }
        } catch (err) {
          secureLog("error", "Unexpected verification error", {
            errorType: err.name,
          });
          showError("An unexpected error occurred during verification.");
        }
      }

      function tryOpenApp() {
        // Security: Rate limit app opening attempts
        if (!rateLimit("tryOpenApp", 2, 10000)) {
          // 2 attempts per 10 seconds
          secureLog("info", "App opening rate limited");
          return;
        }

        const appUrl = "io.supabase.hanapbuhay://";

        // Security: Validate app URL format
        if (!appUrl.startsWith("io.supabase.hanapbuhay://")) {
          secureLog("error", "Invalid app URL format");
          return;
        }

        secureLog("info", "Attempting to open mobile app");

        // Clear any existing timers to prevent multiple redirects
        if (window.appOpenTimer) {
          clearTimeout(window.appOpenTimer);
        }

        // Try multiple methods to open the app with security checks
        try {
          // Method 1: Direct location change (most reliable for mobile)
          window.location.href = appUrl;
        } catch (e) {
          secureLog("warn", "Direct location change failed", {
            error: e.message,
          });
        }

        // Method 2: Hidden iframe approach (works on some mobile browsers)
        setTimeout(() => {
          try {
            const iframe = document.createElement("iframe");
            iframe.style.display = "none";
            iframe.src = appUrl;
            document.body.appendChild(iframe);

            // Clean up after a delay
            setTimeout(() => {
              if (iframe.parentNode) {
                iframe.parentNode.removeChild(iframe);
              }
            }, 2000);
          } catch (e) {
            secureLog("warn", "Iframe method failed", { error: e.message });
          }
        }, 500);

        // Method 3: New tab/window as last resort (desktop browsers)
        window.appOpenTimer = setTimeout(() => {
          try {
            const newTab = window.open(appUrl, "_blank", "noopener,noreferrer");
            if (newTab) {
              newTab.focus();
              // Close the tab after a delay if it didn't redirect to the app
              setTimeout(() => {
                try {
                  newTab.close();
                } catch (e) {
                  // Tab may have already navigated or been closed
                }
              }, 3000);
            }
          } catch (e) {
            secureLog("warn", "New tab method failed", { error: e.message });
          }
        }, 1000);
      }

      function showSuccess() {
        // Security: Clear sensitive data from memory
        accessToken = null;
        refreshToken = null;

        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "block";
        document.getElementById("errorState").style.display = "none";
        document.getElementById("pageTitle").textContent = "✅ Email Verified!";

        // Update app link with security validation
        const appLink = document.getElementById("appLink");
        if (appLink) {
          appLink.href = "io.supabase.hanapbuhay://";
          // Security: Add click tracking for analytics (without sensitive data)
          appLink.addEventListener("click", () => {
            secureLog("info", "User clicked app link manually");
          });
        }

        secureLog("info", "Verification success displayed to user");
      }

      function showDirectAccess() {
        // Enterprise Security: Maximum protection for unauthorized access
        // Based on OWASP guidelines and industry best practices

        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("pageTitle").textContent =
          "🚫 Access Denied - Security Protection Active";

        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.innerHTML = `
            <div style="text-align: center; max-width: 500px; margin: 0 auto;">
              <!-- Security Shield Icon -->
              <div style="font-size: 64px; margin-bottom: 20px; color: #d32f2f;">🛡️</div>

              <!-- Security Alert Header -->
              <h2 style="color: #d32f2f; margin-bottom: 15px; font-size: 24px;">Access Blocked</h2>
              <p style="color: #666; margin-bottom: 25px; font-size: 16px;">
                This protected page requires valid authentication credentials.
              </p>

              <!-- Security Notice Box -->
              <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 2px solid #e57373; border-radius: 12px; padding: 20px; margin: 25px 0; text-align: left;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                  <span style="font-size: 24px; margin-right: 10px;">⚠️</span>
                  <strong style="color: #b71c1c; font-size: 18px;">Security Protection Active</strong>
                </div>
                <ul style="color: #b71c1c; margin: 0; padding-left: 20px; line-height: 1.6;">
                  <li>This page is secured and requires proper authentication</li>
                  <li>Unauthorized access attempts are monitored and logged</li>
                  <li>Only authenticated email verification links are permitted</li>
                  <li>Access is restricted to prevent security breaches</li>
                </ul>
              </div>

              <!-- Instructions Box -->
              <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; margin: 25px 0; text-align: left;">
                <h3 style="color: #013237; margin-bottom: 15px; font-size: 18px;">🔐 How to Access This Page:</h3>
                <ol style="margin: 0; padding-left: 20px; color: #495057; line-height: 1.8;">
                  <li style="margin-bottom: 10px;">Register for a Hanapbuhay account in the mobile app</li>
                  <li style="margin-bottom: 10px;">Check your email for the official verification link</li>
                  <li style="margin-bottom: 10px;">Click the secure verification link from your email</li>
                  <li>The link contains encrypted authentication tokens</li>
                </ol>
              </div>

              <!-- Action Buttons -->
              <div style="margin-top: 30px;">
                <a href="io.supabase.hanapbuhay://" class="app-link" style="margin-right: 15px; margin-bottom: 10px;">
                  📱 Open Hanapbuhay App
                </a>
                <br>
                <a href="#" onclick="window.history.back()" style="color: #6c757d; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">
                  ← Go Back to Previous Page
                </a>
              </div>

              <!-- Footer Security Note -->
              <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d;">
                <p><strong>Security Notice:</strong> This page is protected by enterprise-grade security measures. All access attempts are logged for security auditing purposes.</p>
              </div>
            </div>
          `;
        }

        // Hide default error button since we have custom actions
        const errorState = document.getElementById("errorState");
        if (errorState) {
          const buttonContainer = errorState.querySelector(
            '[style*="text-align: center"]'
          );
          if (buttonContainer) {
            buttonContainer.style.display = "none";
          }
        }

        // Enterprise Security Logging
        secureLog("security", "Unauthorized access attempt blocked", {
          accessType: "direct_access",
          userAgent: navigator.userAgent.substring(0, 150),
          referrer: document.referrer || "direct_access",
          timestamp: new Date().toISOString(),
          ipAddress: "client_side_logging",
          securityLevel: "maximum",
          threatLevel: "low",
          action: "access_denied",
        });
      }

      function showError(message) {
        // Security: Sanitize error message before display
        const sanitizedMessage = sanitizeString(message).substring(0, 200);

        // Security: Clear sensitive data on error
        accessToken = null;
        refreshToken = null;

        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("pageTitle").textContent =
          "❌ Verification Failed";

        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.textContent = sanitizedMessage;
        }

        secureLog("warn", "Verification error displayed to user", {
          errorLength: sanitizedMessage.length,
        });
      }

      // Security: Cleanup sensitive data on page unload
      window.addEventListener("beforeunload", () => {
        accessToken = null;
        refreshToken = null;
        if (window.appOpenTimer) {
          clearTimeout(window.appOpenTimer);
        }
      });

      // Security: Prevent context menu and right-click (optional, for additional security)
      document.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        return false;
      });

      // Security: Prevent drag operations
      document.addEventListener("dragstart", (e) => {
        e.preventDefault();
        return false;
      });

        // Check if this is direct access (no URL parameters)
        const hasAnyParams = window.location.search.length > 1;
        if (!hasAnyParams) {
          // Direct access - show helpful message immediately
          secureLog("info", "Direct page access detected - showing help message");
          showDirectAccess();
        } else {
          // Has parameters - start verification process
          handleVerification();
        }
      })();
    </script>
  </body>
</html>
