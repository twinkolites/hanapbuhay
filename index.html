<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Verification - Hanapbuhay</title>

    <!-- Essential Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />

    <!-- Content Security Policy -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://unpkg.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self';
      connect-src 'self' https://jhpjpenbtazudqfrkogf.supabase.co wss://jhpjpenbtazudqfrkogf.supabase.co;
      frame-src 'none';
      base-uri 'self';
    "
    />

    <!-- SEO and Privacy -->
    <meta name="robots" content="noindex, nofollow" />
    <meta name="description" content="Email verification for Hanapbuhay - Connecting Filipino job seekers with employers nationwide" />

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #eaf9e7 0%, #c0e6ba 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        max-width: 500px;
        margin: 20px;
        background-color: #ffffff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 16px;
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #4ca771 0%, #66bb6a 100%);
        padding: 30px 20px;
        text-align: center;
        color: white;
      }
      .header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
      }
      .content {
        padding: 30px 20px;
      }
      .loading {
        text-align: center;
        padding: 40px 20px;
      }
      .loading .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4ca771;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .success-icon {
        text-align: center;
        margin-bottom: 20px;
      }
      .success-icon .icon {
        font-size: 64px;
        color: #4ca771;
      }
      .error-icon {
        text-align: center;
        margin-bottom: 20px;
      }
      .error-icon .icon {
        font-size: 64px;
        color: #f44336;
      }
      .message {
        text-align: center;
        margin-bottom: 30px;
      }
      .message h2 {
        color: #013237;
        font-size: 20px;
        margin-bottom: 10px;
      }
      .message p {
        color: #666;
        font-size: 16px;
        margin-bottom: 20px;
      }
      .instructions {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
      }
      .instructions.show {
        display: block;
      }
      .instructions h3 {
        color: #013237;
        font-size: 18px;
        margin-bottom: 15px;
      }
      .instruction-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
      }
      .instruction-number {
        background-color: #4ca771;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
      }
      .app-link {
        display: inline-block;
        background-color: #4ca771;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 10px;
        transition: background-color 0.3s;
      }
      .app-link:hover {
        background-color: #3d8f5e;
      }
      .footer {
        background-color: #013237;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 14px;
      }
      .footer p {
        margin: 5px 0;
        opacity: 0.9;
      }
      .troubleshooting {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
      }
      .troubleshooting h4 {
        color: #856404;
        margin-bottom: 10px;
      }
      .troubleshooting p {
        color: #856404;
        font-size: 14px;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1 id="pageTitle">Verifying Email...</h1>
      </div>

      <!-- Main Content -->
      <div class="content">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
          <div class="spinner"></div>
          <p>Verifying your email address...</p>
        </div>

        <!-- Success State -->
        <div id="successState" style="display: none">
          <div class="success-icon">
            <div class="icon">✅</div>
          </div>
          <div class="message">
            <h2>Your email has been successfully verified!</h2>
            <p>
              Welcome to Hanapbuhay! Your account is now active and ready to
              use.
            </p>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
              <strong>For Employers:</strong> Your application is now under review by our admin team. You can log in to check your application status.
            </p>
            <p style="font-size: 14px; color: #666; margin-top: 5px;">
              <strong>For Job Seekers:</strong> You can now start exploring job opportunities and applying for positions.
            </p>
          </div>
          <div class="instructions show">
            <h3>To continue using the app:</h3>
            <div class="instruction-item">
              <div class="instruction-number">1</div>
              <div class="instruction-text">
                Open the Hanapbuhay app on your phone
              </div>
            </div>
            <div class="instruction-item">
              <div class="instruction-number">2</div>
              <div class="instruction-text">
                Sign in with your email and password
              </div>
            </div>
            <div class="instruction-item">
              <div class="instruction-number">3</div>
              <div class="instruction-text">
                Start exploring job opportunities!
              </div>
            </div>
          </div>
          <div style="text-align: center">
            <a href="#" id="appLink" class="app-link">Open Hanapbuhay App</a>
            <p style="font-size: 12px; color: #666; margin-top: 10px">
              If the app doesn't open, please open it manually on your phone.
            </p>
          </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none">
          <div class="error-icon">
            <div class="icon">❌</div>
          </div>
          <div class="message">
            <h2>Verification Failed</h2>
            <p id="errorMessage">
              There was an error verifying your email. Please try again.
            </p>
          </div>
          <div style="text-align: center">
            <a href="#" onclick="window.close()" class="app-link">Close</a>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p><strong>Hanapbuhay</strong></p>
        <p>Connecting Filipino job seekers with employers nationwide</p>
        <p style="font-size: 12px; opacity: 0.7; margin-top: 10px">
          This is an automated verification page.
        </p>
      </div>
    </div>

    <script>
      // Simple logging function
      function log(level, message, data = {}) {
        console[level](`[HANAPBUHAY_VERIFICATION] ${message}`, data);
      }

      // Input sanitization for security
      function sanitizeString(input) {
        if (typeof input !== "string") return "";
        return input.replace(/[<>'"&]/g, "").substring(0, 500);
      }

      // Rate limiting for API calls
      let lastCallTime = 0;
      const RATE_LIMIT_MS = 2000; // 2 seconds between calls
      
      function canMakeCall() {
        const now = Date.now();
        if (now - lastCallTime < RATE_LIMIT_MS) {
          return false;
        }
        lastCallTime = now;
        return true;
      }

      // Initialize Supabase
      const supabaseUrl = "https://jhpjpenbtazudqfrkogf.supabase.co";
      const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpocGpwZW5idGF6dWRxZnJrb2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MjI4MzAsImV4cCI6MjA3MDI5ODgzMH0.pa_xmaWBACJ_8g-wML6z2DEEPa6tHJbXH6S5NndQt2E";

      let supabase;
      try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        log("info", "Supabase client initialized successfully");
      } catch (e) {
        log("error", "Failed to initialize Supabase client", { error: e.message });
        showError("Failed to initialize verification service.");
        return;
      }

      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      const accessToken = urlParams.get("access_token");
      const refreshToken = urlParams.get("refresh_token");
      const type = urlParams.get("type");
      const error = urlParams.get("error");

      log("info", "URL parameters parsed", {
        hasCode: !!code,
        hasAccessToken: !!accessToken,
        hasRefreshToken: !!refreshToken,
        type: type,
        hasError: !!error
      });

      async function handleVerification() {
        if (!canMakeCall()) {
          log("warn", "Rate limit exceeded");
          return;
        }

        try {
          // Check for errors first
          if (error) {
            log("warn", "Verification failed with error", { error });
            showError(`Verification failed: ${sanitizeString(error)}`);
            return;
          }

          // Handle different verification scenarios
          if (code) {
            log("info", "Processing code-based email verification");
            
            try {
              // Try exchangeCodeForSession first (recommended by Supabase)
              const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);

              if (exchangeError) {
                log("warn", "exchangeCodeForSession failed, trying verifyOtp", { error: exchangeError.message });
                
                // Fallback to verifyOtp
                const { data, error: verifyError } = await supabase.auth.verifyOtp({
                  token: code,
                  type: "email",
                });

                if (verifyError) {
                  log("error", "verifyOtp also failed", { error: verifyError.message });
                  showError("Failed to verify your email. The verification code may be expired or invalid. Please try logging into the app - your email might already be verified.");
                  return;
                }

                log("info", "Email verification successful via verifyOtp");
                showSuccess();
                setTimeout(() => tryOpenApp(), 2000);
              } else {
                log("info", "Email verification successful via exchangeCodeForSession");
                showSuccess();
                setTimeout(() => tryOpenApp(), 2000);
              }
            } catch (e) {
              log("error", "Verification process error", { error: e.message });
              showError("An error occurred during verification. Please try logging into the app - your email might already be verified.");
            }
          } else if (accessToken && refreshToken) {
            log("info", "Processing token-based verification");

            try {
              const { data, error: sessionError } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken,
              });

              if (sessionError) {
                log("error", "Session setup failed", { error: sessionError.message });
                showError("Failed to verify your account. Please try logging into the app.");
                return;
              }

              log("info", "Session established successfully");
              showSuccess();
            } catch (e) {
              log("error", "Token verification error", { error: e.message });
              showError("Failed to verify your account. Please try logging into the app.");
            }
          } else if (type === "signup") {
            log("info", "Processing signup confirmation");
            showSuccess();
          } else {
            // Handle cases with unrecognized parameters or direct access
            const hasAnyParams = window.location.search.length > 1;
            
            if (hasAnyParams) {
              log("warn", "Unrecognized verification parameters");
              showError("Invalid verification link format. Please try logging into the app - your email might already be verified.");
            } else {
              log("info", "Direct page access without parameters");
              showDirectAccess();
            }
          }
        } catch (err) {
          log("error", "Unexpected verification error", { error: err.message });
          showError("An unexpected error occurred during verification. Please try logging into the app.");
        }
      }

      function tryOpenApp() {
        if (!canMakeCall()) {
          log("warn", "App opening rate limited");
          return;
        }

        const appUrl = "io.supabase.hanapbuhay://";
        log("info", "Attempting to open mobile app");

        // Clear any existing timers
        if (window.appOpenTimer) {
          clearTimeout(window.appOpenTimer);
        }

        // Try to open the app
        try {
          window.location.href = appUrl;
        } catch (e) {
          log("warn", "Direct location change failed", { error: e.message });
        }

        // Fallback: Try iframe method
        setTimeout(() => {
          try {
            const iframe = document.createElement("iframe");
            iframe.style.display = "none";
            iframe.src = appUrl;
            document.body.appendChild(iframe);

            setTimeout(() => {
              if (iframe.parentNode) {
                iframe.parentNode.removeChild(iframe);
              }
            }, 2000);
          } catch (e) {
            log("warn", "Iframe method failed", { error: e.message });
          }
        }, 500);
      }

      function showSuccess() {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "block";
        document.getElementById("errorState").style.display = "none";
        document.getElementById("pageTitle").textContent = "✅ Email Verified!";

        // Update app link
        const appLink = document.getElementById("appLink");
        if (appLink) {
          appLink.href = "io.supabase.hanapbuhay://";
          appLink.addEventListener("click", () => {
            log("info", "User clicked app link manually");
          });
        }

        log("info", "Verification success displayed to user");
      }

      function showEmailNotVerified(email) {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("pageTitle").textContent = "📧 Email Verification Required";

        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.innerHTML = `
            <div style="text-align: center; max-width: 500px; margin: 0 auto;">
              <div style="font-size: 64px; margin-bottom: 20px; color: #ff9800;">📧</div>
              
              <h2 style="color: #ff9800; margin-bottom: 15px; font-size: 24px;">Email Verification Required</h2>
              <p style="color: #666; margin-bottom: 20px; font-size: 16px;">
                Your account has been created, but your email address needs to be verified.
              </p>
              
              <div style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 15px; margin: 20px 0;">
                <p style="margin: 0; color: #e65100; font-weight: 500;">
                  📧 ${sanitizeString(email)}
                </p>
              </div>
              
              <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: left;">
                <h3 style="color: #013237; margin-bottom: 15px; font-size: 18px;">📋 Next Steps:</h3>
                <ol style="margin: 0; padding-left: 20px; color: #495057; line-height: 1.8;">
                  <li style="margin-bottom: 10px;">Check your email inbox for a verification link</li>
                  <li style="margin-bottom: 10px;">Check your spam/junk folder if you don't see it</li>
                  <li style="margin-bottom: 10px;">Click the verification link in the email</li>
                  <li style="margin-bottom: 10px;">If the link expired, click "Resend Verification Email" below</li>
                </ol>
              </div>

              <div style="margin-top: 20px;">
                <button onclick="resendVerificationEmail('${sanitizeString(email)}')" class="app-link" style="margin-right: 15px; margin-bottom: 10px; border: none; cursor: pointer;">
                  📤 Resend Verification Email
                </button>
                <br>
                <a href="io.supabase.hanapbuhay://" class="app-link" style="margin-right: 15px; margin-bottom: 10px;">
                  📱 Open Hanapbuhay App
                </a>
                <br>
                <a href="#" onclick="window.close()" style="color: #6c757d; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">
                  Close This Page
                </a>
              </div>
            </div>
          `;
        }

        log("info", "Email not verified screen displayed");
      }

      async function resendVerificationEmail(email) {
        if (!canMakeCall()) {
          alert("Too many resend attempts. Please wait before trying again.");
          return;
        }

        try {
          log("info", "Attempting to resend verification email");

          const { error } = await supabase.auth.resend({
            type: 'signup',
            email: email,
            emailRedirectTo: 'https://twinkolites.github.io/hanapbuhay/',
          });

          if (error) {
            log("error", "Failed to resend verification email", { error: error.message });
            alert("Failed to resend verification email: " + error.message);
          } else {
            log("info", "Verification email resent successfully");
            alert("Verification email sent! Please check your inbox.");
          }
        } catch (e) {
          log("error", "Exception while resending verification email", { error: e.message });
          alert("An error occurred while resending the verification email.");
        }
      }

      function showDirectAccess() {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("pageTitle").textContent = "🔐 Email Verification Required";

        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.innerHTML = `
            <div style="text-align: center; max-width: 500px; margin: 0 auto;">
              <div style="font-size: 64px; margin-bottom: 20px; color: #4ca771;">📧</div>
              
              <h2 style="color: #4ca771; margin-bottom: 15px; font-size: 24px;">Welcome to Hanapbuhay</h2>
              <p style="color: #666; margin-bottom: 25px; font-size: 16px;">
                This page is for email verification. You can only access it through a verification link sent to your email.
              </p>

              <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; margin: 25px 0; text-align: left;">
                <h3 style="color: #013237; margin-bottom: 15px; font-size: 18px;">📋 How to verify your email:</h3>
                <ol style="margin: 0; padding-left: 20px; color: #495057; line-height: 1.8;">
                  <li style="margin-bottom: 10px;">Register for a Hanapbuhay account in the mobile app</li>
                  <li style="margin-bottom: 10px;">Check your email for the verification link</li>
                  <li style="margin-bottom: 10px;">Click the verification link from your email</li>
                  <li>Your account will be verified automatically</li>
                </ol>
              </div>

              <div style="margin-top: 30px;">
                <a href="io.supabase.hanapbuhay://" class="app-link" style="margin-right: 15px; margin-bottom: 10px;">
                  📱 Open Hanapbuhay App
                </a>
                <br>
                <a href="#" onclick="window.history.back()" style="color: #6c757d; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">
                  ← Go Back
                </a>
              </div>
            </div>
          `;
        }

        // Hide default error button
        const errorState = document.getElementById("errorState");
        if (errorState) {
          const buttonContainer = errorState.querySelector('[style*="text-align: center"]');
          if (buttonContainer) {
            buttonContainer.style.display = "none";
          }
        }

        log("info", "Direct access screen displayed");
      }

      function showError(message) {
        const sanitizedMessage = sanitizeString(message);

        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("pageTitle").textContent =
          "❌ Verification Failed";

        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          // Enhanced error display with troubleshooting info
          errorElement.innerHTML = `
            <div style="text-align: center; max-width: 500px; margin: 0 auto;">
              <p style="color: #666; margin-bottom: 20px; font-size: 16px;">
                ${sanitizedMessage}
              </p>
              
              <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: left;">
                <h3 style="color: #013237; margin-bottom: 15px; font-size: 18px;">🔧 Troubleshooting Steps:</h3>
                <ol style="margin: 0; padding-left: 20px; color: #495057; line-height: 1.8;">
                  <li style="margin-bottom: 10px;"><strong>Try logging into the app first</strong> - Your email might already be verified</li>
                  <li style="margin-bottom: 10px;">Check your spam/junk folder for the verification email</li>
                  <li style="margin-bottom: 10px;">Make sure you clicked the verification link from your email</li>
                  <li style="margin-bottom: 10px;">Check if the link has expired (verification links expire after 24 hours)</li>
                  <li style="margin-bottom: 10px;">Try requesting a new verification email from the app</li>
                  <li style="margin-bottom: 10px;">Make sure you're using the same email address you registered with</li>
                </ol>
              </div>

              <div style="margin-top: 20px;">
                <a href="io.supabase.hanapbuhay://" class="app-link" style="margin-right: 15px; margin-bottom: 10px;">
                  📱 Open Hanapbuhay App
                </a>
                <br>
                <a href="#" onclick="window.close()" style="color: #6c757d; text-decoration: underline; font-size: 14px; margin-top: 10px; display: inline-block;">
                  Close This Page
                </a>
              </div>
            </div>
          `;
        }

        log("warn", "Verification error displayed to user");
      }

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (window.appOpenTimer) {
          clearTimeout(window.appOpenTimer);
        }
      });

      // Start verification process
      const hasAnyParams = window.location.search.length > 1;
      if (!hasAnyParams) {
        log("info", "Direct page access detected");
        showDirectAccess();
      } else {
        log("info", "Starting verification process");
        handleVerification();
      }
    </script>
  </body>
</html>
